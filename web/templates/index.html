<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CreatorGuard Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <span class="text-xl font-bold">CreatorGuard</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    {% if current_user.is_admin %}
                    <a href="{{ url_for('views.admin_dashboard') }}"
                       class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">
                        Admin
                    </a>
                    {% endif %}
                    <a href="{{ url_for('auth.logout') }}"
                       class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-50">
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8" id="app">
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium text-gray-900">Import YouTube Video</h3>
                <div class="mt-4">
                    <form @submit.prevent="importVideo" class="flex gap-4">
                        <div class="flex-grow">
                            <input type="text" v-model="newVideoId" placeholder="Enter YouTube Video ID"
                                   class="block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2">
                        </div>
                        <button type="submit"
                                :disabled="importing"
                                :class="{'opacity-50 cursor-not-allowed': importing}"
                                class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700">
                            [[ importing ? 'Importing...' : 'Import Video' ]]
                        </button>
                    </form>
                    <p v-if="importError" class="mt-2 text-sm text-red-600">[[ importError ]]</p>
                </div>
            </div>
        </div>

        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium text-gray-900">Your Videos</h3>
                <div v-if="loading" class="mt-4 text-center">
                    <p class="text-gray-500">Loading videos...</p>
                </div>
                <div v-else-if="videos.length === 0" class="mt-4 text-center">
                    <p class="text-gray-500">No videos imported yet. Import your first video above.</p>
                </div>
                <div v-else class="mt-4">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Video</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Channel</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comments</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">First Comment</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Comment</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr v-for="video in videos" :key="video.video_id">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 h-10 w-10">
                                                <img :src="video.thumbnail_url" :alt="video.title" class="h-10 w-10 rounded">
                                            </div>
                                            <div class="ml-4">
                                                <a :href="'https://youtube.com/watch?v=' + video.video_id" 
                                                   target="_blank"
                                                   class="text-sm font-medium text-gray-900 hover:text-blue-600">
                                                    [[ video.title ]]
                                                </a>
                                                <div class="text-xs text-gray-500">ID: [[ video.video_id ]]</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">[[ video.channel_title ]]</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">[[ video.comment_count ]]</div>
                                        <div class="text-xs text-gray-500">
                                            <span v-if="video.toxic_count" class="text-red-600">[[ video.toxic_count ]] toxic</span>
                                            <span v-if="video.questionable_count" class="text-yellow-600">[[ video.questionable_count ]] questionable</span>
                                            <span v-if="video.spam_count" class="text-orange-600">[[ video.spam_count ]] spam</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">[[ formatDate(video.first_comment) ]]</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">[[ formatDate(video.last_comment) ]]</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <button @click="viewInsights(video.video_id)"
                                                class="text-blue-600 hover:text-blue-900 mr-3">
                                            View Insights
                                        </button>
                                        <button @click="viewMetrics()"
                                                class="text-blue-600 hover:text-blue-900">
                                            View Metrics
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comment Insights Modal -->
        <div v-if="showInsights" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-20 mx-auto p-5 border w-4/5 shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-xl font-medium text-gray-900">Video Comments</h3>
                    <button @click="closeInsights" class="text-gray-400 hover:text-gray-500">
                        <span class="text-2xl">&times;</span>
                    </button>
                </div>
                
                <div class="mt-4">
                    <div class="flex space-x-4 mb-4">
                        <button 
                            v-for="filter in ['all', 'spam', 'toxic', 'questionable', 'safe']"
                            :key="filter"
                            @click="filterComments(filter)"
                            :class="{
                                'px-4 py-2 rounded-md': true,
                                'bg-blue-600 text-white': currentFilter === filter,
                                'bg-gray-200 text-gray-700': currentFilter !== filter
                            }"
                        >
                            [[ filter.charAt(0).toUpperCase() + filter.slice(1) ]]
                        </button>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div v-if="selectedComments.length > 0" class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-600">
                                [[ selectedComments.length ]] comments selected
                            </div>
                            <div class="flex space-x-2">
                                <button 
                                    @click="markSelectedAsSpam(true)"
                                    class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700"
                                >
                                    Mark Selected as Spam
                                </button>
                                <button 
                                    @click="markSelectedAsSpam(false)"
                                    class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                                >
                                    Mark Selected as Not Spam
                                </button>
                                <button 
                                    @click="clearSelection"
                                    class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
                                >
                                    Clear Selection
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        <input 
                                            type="checkbox" 
                                            v-model="selectAll"
                                            @change="toggleSelectAll"
                                            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        >
                                    </th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Author</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comment</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr v-for="comment in filteredComments" :key="comment.id">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <input 
                                            type="checkbox" 
                                            v-model="selectedComments"
                                            :value="comment.comment_id"
                                            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                        >
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">[[ comment.author ]]</div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-sm text-gray-900">[[ comment.text ]]</div>
                                        <div v-if="comment.spam_score" class="text-xs text-gray-500 mt-1">
                                            Spam Score: [[ (comment.spam_score * 100).toFixed(1) ]]%
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="{
                                            'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true,
                                            'bg-red-100 text-red-800': comment.classification === 'toxic',
                                            'bg-yellow-100 text-yellow-800': comment.classification === 'questionable',
                                            'bg-orange-100 text-orange-800': comment.is_spam,
                                            'bg-green-100 text-green-800': comment.classification === 'safe'
                                        }">
                                            [[ comment.is_spam ? 'Spam' : comment.classification ]]
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <button 
                                            @click="markAsSpam(comment.comment_id, !comment.is_spam)"
                                            :class="{
                                                'text-sm px-3 py-1 rounded': true,
                                                'bg-orange-600 text-white hover:bg-orange-700': !comment.is_spam,
                                                'bg-green-600 text-white hover:bg-green-700': comment.is_spam
                                            }"
                                        >
                                            [[ comment.is_spam ? 'Not Spam' : 'Mark as Spam' ]]
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metrics Modal -->
        <div v-if="showMetrics" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
            <div class="relative top-20 mx-auto p-5 border w-4/5 shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-xl font-medium text-gray-900">Spam Detection Metrics</h3>
                    <button @click="closeMetrics" class="text-gray-400 hover:text-gray-500">
                        <span class="text-2xl">&times;</span>
                    </button>
                </div>
                
                <div class="mt-4">
                    <!-- Current Metrics -->
                    <div v-if="metrics.current" class="grid grid-cols-4 gap-4 mb-8">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-500">Accuracy</div>
                            <div class="text-2xl font-semibold text-gray-900">
                                [[ (metrics.current.accuracy * 100).toFixed(1) ]]%
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-500">Precision</div>
                            <div class="text-2xl font-semibold text-gray-900">
                                [[ (metrics.current.precision * 100).toFixed(1) ]]%
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-500">Recall</div>
                            <div class="text-2xl font-semibold text-gray-900">
                                [[ (metrics.current.recall * 100).toFixed(1) ]]%
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-500">F1 Score</div>
                            <div class="text-2xl font-semibold text-gray-900">
                                [[ (metrics.current.f1 * 100).toFixed(1) ]]%
                            </div>
                        </div>
                    </div>
                    
                    <!-- Trends Chart -->
                    <div class="bg-white p-4 rounded-lg shadow mb-8">
                        <h4 class="text-lg font-medium text-gray-900 mb-4">Spam Trends</h4>
                        <canvas ref="trendChart" width="400" height="200"></canvas>
                    </div>
                    
                    <!-- Metrics History -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h4 class="text-lg font-medium text-gray-900 mb-4">Model Performance History</h4>
                        <canvas ref="metricsChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const { createApp } = Vue

            createApp({
                delimiters: ['[[', ']]'],
                data() {
                    return {
                        videos: [],
                        loading: true,
                        importing: false,
                        newVideoId: '',
                        importError: '',
                        showInsights: false,
                        currentVideoId: null,
                        comments: [],
                        currentFilter: 'all',
                        selectedComments: [],
                        selectAll: false,
                        showMetrics: false,
                        metrics: {
                            current: null,
                            history: [],
                            trends: []
                        },
                        trendChart: null,
                        metricsChart: null,
                        loadingMetrics: false
                    }
                },
                computed: {
                    filteredComments() {
                        if (this.currentFilter === 'all') return this.comments;
                        if (this.currentFilter === 'spam') return this.comments.filter(c => c.is_spam);
                        return this.comments.filter(c => c.classification === this.currentFilter);
                    }
                },
                mounted() {
                    this.fetchVideos()
                },
                methods: {
                    async fetchVideos() {
                        try {
                            this.loading = true
                            const response = await axios.get('/api/videos')
                            this.videos = response.data
                        } catch (error) {
                            console.error('Error fetching videos:', error)
                        } finally {
                            this.loading = false
                        }
                    },
                    async importVideo() {
                        if (!this.newVideoId) return
                        
                        try {
                            this.importing = true
                            this.importError = ''
                            
                            const formData = new FormData()
                            formData.append('video_id', this.newVideoId)
                            
                            await axios.post('/api/videos/import', formData)
                            this.newVideoId = ''
                            await this.fetchVideos()
                        } catch (error) {
                            console.error('Error importing video:', error)
                            this.importError = error.response?.data?.error || 'Failed to import video'
                        } finally {
                            this.importing = false
                        }
                    },
                    async viewInsights(videoId) {
                        try {
                            this.showInsights = true
                            this.currentVideoId = videoId
                            const response = await axios.get(`/api/videos/${videoId}/comments`)
                            this.comments = response.data
                        } catch (error) {
                            console.error('Error loading insights:', error)
                        }
                    },
                    closeInsights() {
                        this.showInsights = false
                        this.currentVideoId = null
                        this.comments = []
                        this.currentFilter = 'all'
                    },
                    filterComments(filter) {
                        this.currentFilter = filter
                    },
                    async markAsSpam(commentId, isSpam) {
                        try {
                            const response = await axios.post(`/api/comments/${commentId}/mark_spam`, {
                                is_spam: isSpam
                            });
                            
                            if (response.data.status === 'error') {
                                throw new Error(response.data.error);
                            }
                            
                            // Refresh comments to show updated status
                            await this.viewInsights(this.currentVideoId);
                            
                            // Show notification if model was retrained
                            if (response.data.status === 'retrained') {
                                alert('Spam detection model has been retrained with new data!');
                            }
                        } catch (error) {
                            console.error('Error marking as spam:', error);
                            alert(error.response?.data?.error || 'Failed to update spam status');
                        }
                    },
                    toggleSelectAll() {
                        if (this.selectAll) {
                            this.selectedComments = this.filteredComments.map(c => c.comment_id);
                        } else {
                            this.selectedComments = [];
                        }
                    },
                    
                    clearSelection() {
                        this.selectedComments = [];
                        this.selectAll = false;
                    },
                    
                    async markSelectedAsSpam(isSpam) {
                        if (!this.selectedComments.length) return;
                        
                        try {
                            const response = await axios.post('/api/comments/mark_spam_bulk', {
                                comment_ids: this.selectedComments,
                                is_spam: isSpam
                            });
                            
                            if (response.data.status === 'error') {
                                throw new Error(response.data.error);
                            }
                            
                            // Refresh comments
                            await this.viewInsights(this.currentVideoId);
                            
                            // Clear selection
                            this.clearSelection();
                            
                            // Show results
                            const {processed, total} = response.data;
                            alert(`Successfully marked ${processed} out of ${total} comments`);
                            
                            // Show retraining notification
                            if (response.data.status === 'retrained') {
                                alert('Spam detection model has been retrained with new data!');
                            }
                        } catch (error) {
                            console.error('Error marking comments as spam:', error);
                            alert(error.response?.data?.error || 'Failed to update spam status');
                        }
                    },
                    async viewMetrics() {
                        if (this.loadingMetrics) return;
                        
                        try {
                            this.loadingMetrics = true;
                            this.showMetrics = true;
                            
                            const response = await axios.get('/api/metrics/spam');
                            if (!response.data) {
                                throw new Error('No metrics data received');
                            }
                            
                            this.metrics = {
                                current: response.data.current || null,
                                history: response.data.history || [],
                                trends: response.data.trends || []
                            };
                            
                            // Wait for Vue to update the DOM
                            await this.$nextTick();
                            
                            if (this.metrics.trends.length > 0) {
                                this.renderTrendChart();
                            }
                            
                            if (this.metrics.history.length > 0) {
                                this.renderMetricsChart();
                            }
                            
                        } catch (error) {
                            console.error('Error fetching metrics:', error);
                            alert(error.response?.data?.error || 'Failed to load metrics. Please try again.');
                        } finally {
                            this.loadingMetrics = false;
                        }
                    },
                    closeMetrics() {
                        this.showMetrics = false;
                        if (this.trendChart) {
                            this.trendChart.destroy();
                            this.trendChart = null;
                        }
                        if (this.metricsChart) {
                            this.metricsChart.destroy();
                            this.metricsChart = null;
                        }
                    },
                    renderTrendChart() {
                        if (!this.$refs.trendChart) {
                            console.error('Trend chart canvas not found');
                            return;
                        }
                        
                        const ctx = this.$refs.trendChart.getContext('2d');
                        if (this.trendChart) {
                            this.trendChart.destroy();
                        }
                        
                        const data = this.metrics.trends;
                        if (!data || data.length === 0) {
                            console.warn('No trend data available');
                            return;
                        }
                        
                        this.trendChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.map(d => d.date),
                                datasets: [{
                                    label: 'Spam Ratio',
                                    data: data.map(d => (d.ratio * 100).toFixed(1)),
                                    borderColor: 'rgb(234, 88, 12)',
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Spam %'
                                        }
                                    }
                                }
                            }
                        });
                    },
                    renderMetricsChart() {
                        if (!this.$refs.metricsChart) {
                            console.error('Metrics chart canvas not found');
                            return;
                        }
                        
                        const ctx = this.$refs.metricsChart.getContext('2d');
                        if (this.metricsChart) {
                            this.metricsChart.destroy();
                        }
                        
                        const data = this.metrics.history;
                        if (!data || data.length === 0) {
                            console.warn('No metrics history available');
                            return;
                        }
                        
                        this.metricsChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.map(d => new Date(d.created_at).toLocaleDateString()),
                                datasets: [
                                    {
                                        label: 'Accuracy',
                                        data: data.map(d => (d.metrics.accuracy * 100).toFixed(1)),
                                        borderColor: 'rgb(59, 130, 246)',
                                        tension: 0.1
                                    },
                                    {
                                        label: 'Precision',
                                        data: data.map(d => (d.metrics.precision * 100).toFixed(1)),
                                        borderColor: 'rgb(16, 185, 129)',
                                        tension: 0.1
                                    },
                                    {
                                        label: 'Recall',
                                        data: data.map(d => (d.metrics.recall * 100).toFixed(1)),
                                        borderColor: 'rgb(245, 158, 11)',
                                        tension: 0.1
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Score %'
                                        }
                                    }
                                }
                            }
                        });
                    },
                    formatDate(timestamp) {
                        if (!timestamp) return ''
                        return new Date(timestamp).toLocaleString()
                    }
                },
                watch: {
                    filteredComments() {
                        // Update selectAll when filtered comments change
                        this.selectAll = this.filteredComments.length > 0 && 
                                       this.selectedComments.length === this.filteredComments.length;
                    }
                }
            }).mount('#app')
        </script>
    </main>
</body>
</html>
